import e,{createContext as n,useContext as t,useMemo as r,useRef as a,useEffect as i,useState as o,useCallback as d}from"react";import{useEditor as c,DerivedEventHandlers as l,useEventHandler as s}from"@craftjs/core";import{useCollector as u,ROOT_NODE as p,defineEventListener as f,RenderIndicator as g,useMethods as v}from"@craftjs/utils";import h from"styled-components";import m from"react-contenteditable";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var y=function(e,n){return(y=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var t in n)n.hasOwnProperty(t)&&(e[t]=n[t])})(e,n)},x=function(){return(x=Object.assign||function(e){for(var n,t=1,r=arguments.length;t<r;t++)for(var a in n=arguments[t])Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a]);return e}).apply(this,arguments)};function b(e,n){var t={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&n.indexOf(r)<0&&(t[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(r=Object.getOwnPropertySymbols(e);a<r.length;a++)n.indexOf(r[a])<0&&Object.prototype.propertyIsEnumerable.call(e,r[a])&&(t[r[a]]=e[r[a]])}return t}function E(e,n){return Object.defineProperty?Object.defineProperty(e,"raw",{value:n}):e.raw=n,e}var w=e.createContext({}),O=n({});function C(e){var n=t(O).store;return u(n,e)}function L(e){var n=t(w),a=n.id,i=n.depth,o=n.connectors,d=C((function(n){return a&&n.layers[a]&&e&&e(n.layers[a])})),l=d.actions,s=b(d,["actions"]),u=c((function(e,n){return{children:e.nodes[a]&&n.node(a).descendants()}})).children,p=r((function(){return{toggleLayer:function(){return l.toggleLayer(a)}}}),[l,a]);return x({id:a,depth:i,children:u,actions:p,connectors:o},s)}var k=function(){var n=L((function(e){return{expanded:e.expanded}})),t=n.id,r=n.depth,o=n.children,d=n.expanded,l=c((function(e,n){return{data:e.nodes[t]&&e.nodes[t].data,shouldBeExpanded:e.events.selected&&n.node(e.events.selected).ancestors(!0).includes(t)}})),s=l.data,u=l.shouldBeExpanded,f=C((function(e){return{renderLayer:e.options.renderLayer,expandRootOnLoad:e.options.expandRootOnLoad}})),g=f.actions,v=f.renderLayer,h=f.expandRootOnLoad,m=a(d);m.current=d;var y=a(h&&t===p);i((function(){!m.current&&u&&g.toggleLayer(t)}),[g,t,u]),i((function(){y.current&&g.toggleLayer(t)}),[g,t]);var x=a(!1);return x.current||(g.registerLayer(t),x.current=!0),s?e.createElement("div",{className:"craft-layer-node "+t},e.createElement(v,{},o&&d?o.map((function(n){return e.createElement(P,{key:n,id:n,depth:r+1})})):null)):null},j=function(e){function n(n,t,r,a){var i=e.call(this,n,t)||this;return i.id=a,i.layerStore=r,i}return function(e,n){function t(){this.constructor=e}y(e,n),e.prototype=null===n?Object.create(n):(t.prototype=n.prototype,new t)}(n,e),n.prototype.getLayer=function(e){return this.layerStore.getState().layers[e]},n.prototype.handlers=function(){var e=this,t=this.derived.connectors();return{layer:{init:function(n){t.select(n,e.id),t.hover(n,e.id),t.drag(n,e.id),e.layerStore.actions.setDOM(e.id,{dom:n})},events:[f("mouseover",(function(n,t){n.craft.stopPropagation(),e.layerStore.actions.setLayerEvent("hovered",t)})),f("dragover",(function(t){t.craft.stopPropagation(),t.preventDefault();var r=n.events,a=r.indicator,i=r.currentCanvasHovered;if(i&&a&&i.data.nodes){var o=e.getLayer(i.id).headingDom.getBoundingClientRect();if(t.clientY>o.top+10&&t.clientY<o.bottom-10){var d=i.data.nodes[i.data.nodes.length-1];if(!d)return;a.placement.currentNode=e.store.query.node(d).get(),a.placement.index=i.data.nodes.length,a.placement.where="after",a.placement.parent=i,n.events.indicator=x(x({},a),{onCanvas:!0}),e.layerStore.actions.setIndicator(n.events.indicator)}}})),f("dragenter",(function(t){t.craft.stopPropagation(),t.preventDefault();var r=n.draggedElement;if(r){var a=e.store.query.getDropPlaceholder(r,e.id,{x:t.clientX,y:t.clientY},(function(n){var t=e.getLayer(n.id);return t&&t.dom}));if(a){var i=a.placement.parent,o=e.getLayer(i.id).headingDom.getBoundingClientRect();if(n.events.currentCanvasHovered=null,e.store.query.node(i.id).isCanvas()&&i.data.parent){var d=e.store.query.node(i.data.parent).get();e.store.query.node(d.id).isCanvas()&&(n.events.currentCanvasHovered=i,(t.clientY>o.bottom-10&&!e.getLayer(i.id).expanded||t.clientY<o.top+10)&&(a.placement.parent=d,a.placement.currentNode=i,a.placement.index=d.data.nodes?d.data.nodes.indexOf(i.id):0,t.clientY>o.bottom-10&&!e.getLayer(i.id).expanded?a.placement.where="after":t.clientY<o.top+10&&(a.placement.where="before")))}n.events.indicator=x(x({},a),{onCanvas:!1}),e.layerStore.actions.setIndicator(n.events.indicator)}}}))]},layerHeader:{init:function(n){e.layerStore.actions.setDOM(e.id,{headingDom:n})}},drag:{init:function(e){return e.setAttribute("draggable",!0),function(){e.removeAttribute("draggable")}},events:[f("dragstart",(function(t){t.craft.stopPropagation(),n.draggedElement=e.id})),f("dragend",(function(t,r){t.craft.stopPropagation();var a=n.events;if(a.indicator&&!a.indicator.error){var i=a.indicator.placement;e.store.actions.move(n.draggedElement,i.parent.id,i.index+("after"===i.where?1:0))}n.draggedElement=null,n.events.indicator=null,e.layerStore.actions.setIndicator(null)}))]}}},n.events={indicator:null,currentCanvasHovered:null},n}(l),P=function(n){var a=n.id,i=n.depth,o=s(),d=t(O).store,l=r((function(){return o.derive(j,d,a).connectors()}),[o,a,d]);return c((function(e){return{exists:!!e.nodes[a]}})).exists?e.createElement(w.Provider,{value:{id:a,depth:i,connectors:l}},e.createElement(k,null)):null},N=function(n){var t=n.children,a=C((function(e){return e})),i=a.layers,o=a.events,d=c((function(e){return{enabled:e.options.enabled}})).query.getOptions().indicator,l=r((function(){var e=o.indicator;if(e){var n=e.placement,t=n.where,r=n.parent,a=n.currentNode,c=a?a.id:r.id,l=e.error?d.error:d.success;if(e.onCanvas&&null!=i[r.id].dom){var s=i[r.id].dom.getBoundingClientRect(),u=i[r.id].headingDom.getBoundingClientRect();return{top:u.top,left:s.left,width:s.width,height:u.height,background:"transparent",borderWidth:"1px",borderColor:l}}if(!i[c])return;var p=i[c].headingDom.getBoundingClientRect(),f=i[c].dom.getBoundingClientRect();return{top:"after"!==t&&a?f.top:f.top+f.height,left:p.left,width:f.width-p.left,height:2,borderWidth:0,background:l}}}),[o,d.error,d.success,i]);return e.createElement("div",null,o.indicator?e.createElement(g,{style:l}):null,t)},D=function(e){return{setLayerEvent:function(n,t){if(null===t||e.layers[t]){var r=e.events[n];r&&t!==r&&(e.layers[r].event[n]=!1),t?(e.layers[t].event[n]=!0,e.events[n]=t):e.events[n]=null}},registerLayer:function(n){e.layers[n]||(e.layers[n]={expanded:!1,id:n,event:{selected:!1,hovered:!1}})},setDOM:function(n,t){e.layers[n]=x(x(x({},e.layers[n]),t.dom?{dom:t.dom}:{}),t.headingDom?{headingDom:t.headingDom}:{})},toggleLayer:function(n){e.layers[n].expanded=!e.layers[n].expanded},setIndicator:function(n){e.events.indicator=n}}};function z(){return(z=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e}).apply(this,arguments)}var _=e.createElement("path",{fill:"none",d:"M0 0h24v24H0z"}),H=e.createElement("path",{d:"M1.181 12C2.121 6.88 6.608 3 12 3c5.392 0 9.878 3.88 10.819 9-.94 5.12-5.427 9-10.819 9-5.392 0-9.878-3.88-10.819-9zM12 17a5 5 0 100-10 5 5 0 000 10zm0-2a3 3 0 110-6 3 3 0 010 6z"}),B=function(n){return e.createElement("svg",z({viewBox:"0 0 24 24",width:16,height:16},n),_,H)};function S(){return(S=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e}).apply(this,arguments)}var M=e.createElement("path",{d:"M9.99 1.01A1 1 0 008.283.303L5 3.586 1.717.303A1 1 0 10.303 1.717l3.99 3.98a1 1 0 001.414 0l3.99-3.98a.997.997 0 00.293-.707z"}),R=function(n){return e.createElement("svg",S({viewBox:"0 0 10 6"},n),M)};function Y(){return(Y=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e}).apply(this,arguments)}var q,A,I,V,T,W,X=e.createElement("path",{className:"linked_svg__a",d:"M16.5 9h-1a.5.5 0 00-.5.5V15H3V3h5.5a.5.5 0 00.5-.5v-1a.5.5 0 00-.5-.5h-7a.5.5 0 00-.5.5v15a.5.5 0 00.5.5h15a.5.5 0 00.5-.5v-7a.5.5 0 00-.5-.5z"}),F=e.createElement("path",{className:"linked_svg__a",d:"M16.75 1h-5.373a.4.4 0 00-.377.4.392.392 0 00.117.28l1.893 1.895-3.52 3.521a.5.5 0 000 .707l.706.708a.5.5 0 00.708 0l3.521-3.521 1.893 1.892A.39.39 0 0016.6 7a.4.4 0 00.4-.377V1.25a.25.25 0 00-.25-.25z"}),G=function(n){return e.createElement("svg",Y({viewBox:"0 0 18 18"},n),X,F)},J=function(){var n=L().id,t=c((function(e){return{displayName:e.nodes[n]&&e.nodes[n].data.custom.displayName?e.nodes[n].data.custom.displayName:e.nodes[n].data.displayName,hidden:e.nodes[n]&&e.nodes[n].data.hidden}})),r=t.displayName,l=t.actions,s=o(!1),u=s[0],p=s[1],f=a(null),g=d((function(e){f.current&&!f.current.contains(e.target)&&p(!1)}),[]);return i((function(){return function(){window.removeEventListener("click",g)}}),[g]),e.createElement(m,{html:r,disabled:!u,ref:function(e){e&&(f.current=e.el.current,window.removeEventListener("click",g),window.addEventListener("click",g))},onChange:function(e){l.setCustom(n,(function(n){return n.displayName=e.target.value}))},tagName:"h2",onDoubleClick:function(){u||p(!0)}})},K=h.div(q||(q=E(["\n  display: flex;\n  flex-direction: row;\n  align-items: center;\n  padding: 4px 10px;\n  background: ",";\n  color: ",";\n  svg {\n    fill: ",";\n    margin-top: 2px;\n  }\n  .inner {\n    flex: 1;\n    > div {\n      padding: 0px;\n      flex: 1;\n      display: flex;\n      margin-left: ","px;\n      align-items: center;\n      div.layer-name {\n        flex: 1;\n        h2 {\n          font-size: 15px;\n          line-height: 26px;\n        }\n      }\n    }\n  }\n"],["\n  display: flex;\n  flex-direction: row;\n  align-items: center;\n  padding: 4px 10px;\n  background: ",";\n  color: ",";\n  svg {\n    fill: ",";\n    margin-top: 2px;\n  }\n  .inner {\n    flex: 1;\n    > div {\n      padding: 0px;\n      flex: 1;\n      display: flex;\n      margin-left: ","px;\n      align-items: center;\n      div.layer-name {\n        flex: 1;\n        h2 {\n          font-size: 15px;\n          line-height: 26px;\n        }\n      }\n    }\n  }\n"])),(function(e){return e.selected?"#2680eb":"transparent"}),(function(e){return e.selected?"#fff":"inherit"}),(function(e){return e.selected?"#fff":"#808184"}),(function(e){return 10*e.depth})),Q=h.a(A||(A=E(["\n  width: 8px;\n  height: 8px;\n  display: block;\n  transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1);\n  transform: rotate(","deg);\n  opacity: 0.7;\n  cursor: pointer;\n  transform-origin: 60% center;\n"],["\n  width: 8px;\n  height: 8px;\n  display: block;\n  transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1);\n  transform: rotate(","deg);\n  opacity: 0.7;\n  cursor: pointer;\n  transform-origin: 60% center;\n"])),(function(e){return e.expanded?180:0})),U=h.a(I||(I=E(["\n  width: 14px;\n  height: 14px;\n  margin-right: 10px;\n  position: relative;\n  transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1);\n  cursor: pointer;\n\n  svg {\n    width: 100%;\n    height: 100%;\n    object-fit: contain;\n    opacity: ",";\n  }\n  &:after {\n    content: ' ';\n    width: 2px;\n    height: ","%;\n    position: absolute;\n    left: 2px;\n    top: 3px;\n    background: ",";\n    transform: rotate(-45deg);\n    transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1);\n    transform-origin: 0% 0%;\n    opacity: ",";\n  }\n"],["\n  width: 14px;\n  height: 14px;\n  margin-right: 10px;\n  position: relative;\n  transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1);\n  cursor: pointer;\n\n  svg {\n    width: 100%;\n    height: 100%;\n    object-fit: contain;\n    opacity: ",";\n  }\n  &:after {\n    content: ' ';\n    width: 2px;\n    height: ","%;\n    position: absolute;\n    left: 2px;\n    top: 3px;\n    background: ",";\n    transform: rotate(-45deg);\n    transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1);\n    transform-origin: 0% 0%;\n    opacity: ",";\n  }\n"])),(function(e){return e.isHidden?.2:1}),(function(e){return e.isHidden?100:0}),(function(e){return e.selected?"#fff":"#808184"}),(function(e){return e.isHidden?.4:1})),Z=h.div(V||(V=E(["\n  margin-left: -22px;\n  margin-right: 10px;\n\n  svg {\n    width: 12px;\n    height: 12px;\n  }\n"],["\n  margin-left: -22px;\n  margin-right: 10px;\n\n  svg {\n    width: 12px;\n    height: 12px;\n  }\n"]))),$=function(){var n=L((function(e){return{expanded:e.expanded}})),t=n.id,r=n.depth,a=n.expanded,i=n.children,o=n.connectors,d=o.drag,l=o.layerHeader,s=n.actions.toggleLayer,u=c((function(e,n){return{hidden:e.nodes[t]&&e.nodes[t].data.hidden,selected:e.events.selected===t,topLevel:n.node(t).isTopLevelCanvas()}})),p=u.hidden,f=u.actions,g=u.selected,v=u.topLevel;return e.createElement(K,{selected:g,ref:d,depth:r},e.createElement(U,{selected:g,isHidden:p,onClick:function(){return f.setHidden(t,!p)}},e.createElement(B,null)),e.createElement("div",{className:"inner"},e.createElement("div",{ref:l},v?e.createElement(Z,null,e.createElement(G,null)):null,e.createElement("div",{className:"layer-name s"},e.createElement(J,null)),e.createElement("div",null,i&&i.length?e.createElement(Q,{expanded:a,onMouseDown:function(){return s()}},e.createElement(R,null)):null))))},ee=h.div(T||(T=E(["\n  background: ",";\n  display: block;\n  padding-bottom: ","px;\n"],["\n  background: ",";\n  display: block;\n  padding-bottom: ","px;\n"])),(function(e){return e.hovered?"#f1f1f1":"transparent"}),(function(e){return e.hasCanvases&&e.expanded?5:0})),ne=h.div(W||(W=E(["\n  margin: 0 0 0 ","px;\n  background: ",";\n  position: relative;\n\n  ","\n"],["\n  margin: 0 0 0 ","px;\n  background: ",";\n  position: relative;\n\n  ","\n"])),(function(e){return e.hasCanvases?35:0}),(function(e){return e.hasCanvases?"rgba(255, 255, 255, 0.02)":"transparent"}),(function(e){return e.hasCanvases?'\n  \n  box-shadow: 0px 0px 44px -1px #00000014;\n  border-radius: 10px;\n  margin-right: 5px;\n  margin-bottom:5px;\n  margin-top:5px; \n  > * { overflow:hidden; }\n    &:before { \n      position:absolute;\n      left:-19px;\n      width: 2px;\n      height:100%;\n      content: " ";\n      background:#00000012;\n    }\n  ':""})),te=function(n){var t=n.children,r=L((function(e){return{hovered:e.event.hovered,expanded:e.expanded}})),a=r.id,i=r.expanded,o=r.hovered,d=r.connectors.layer,l=c((function(e,n){return{hasChildCanvases:n.node(a).isParentOfTopLevelNodes()}})).hasChildCanvases;return e.createElement(ee,{ref:d,expanded:i,hasCanvases:l,hovered:o},e.createElement($,null),t?e.createElement(ne,{hasCanvases:l,className:"craft-layer-children"},t):null)},re=function(n){var t=n.children,r=v(D,{layers:{},events:{selected:null,dragged:null,hovered:null},options:x({renderLayer:te},n.options)});return e.createElement(O.Provider,{value:{store:r}},e.createElement(N,null,t))},ae=function(n){var t=b(n,[]);return e.createElement(re,{options:t},e.createElement(P,{id:p,depth:0}))};export{ae as Layers,L as useLayer};
